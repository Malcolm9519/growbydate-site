
<section class="section">
  <div id="first-frost-planner" class="toolRoot">

    <section class="card" aria-labelledby="ff-title">
      <header>
        <h2 id="ff-title">First frost → fall planting window</h2>
        <p class="small" style="opacity:0.86;">
          Enter your <strong>average first fall frost date</strong>. This tool counts backward using days to maturity + your buffer.
        </p>
      </header>

      <div role="form" aria-describedby="ff-assumptions">
        <div style="margin-top:10px;">
          <label for="firstFrost"><strong>Average first fall frost date</strong></label>
          <input id="firstFrost" type="date" aria-describedby="firstFrostHelp ff-error" />
          <div class="small" id="firstFrostHelp">Use the typical first frost for your area (not the earliest ever).</div>
        </div>

        <div style="margin-top:10px;">
          <label><strong>Crops</strong></label>
          <div class="small" id="cropHelp">Select one or more crops to calculate fall cutoffs.</div>
          <div id="cropList" class="cropList" aria-describedby="cropHelp"></div>
        </div>

        <div style="margin-top:10px;">
          <label for="protection"><strong>Season extension</strong></label>
          <select id="protection" aria-describedby="protectionHelp">
            <option value="0">None</option>
            <option value="7">Light protection (row cover / cloche) — ~1 week</option>
            <option value="14">Stronger protection (tunnel / cold frame) — ~2 weeks</option>
          </select>
          <div class="small" id="protectionHelp">Shifts your effective frost date later by ~1–2 weeks.</div>
        </div>

        <div style="margin-top:10px;">
          <label for="buffer"><strong>Safety buffer</strong></label>
          <select id="buffer" aria-describedby="bufferHelp">
            <option value="7">Conservative (7 days)</option>
            <option value="10" selected>Standard (10 days)</option>
            <option value="14">Extra cautious (14 days)</option>
            <option value="0">None</option>
          </select>
          <div class="small" id="bufferHelp">Accounts for slower fall growth, cool soil, and harvest delays.</div>
        </div>

        <details class="note small" id="ff-assumptions" style="opacity:0.9; margin-top:12px;">
          <summary><span class="pill">Assumptions</span> What this tool is doing</summary>
          <ul class="tight" style="margin:0.5rem 0 0 1.25rem;">
            <li>Counts backward from your <strong>average first frost</strong>.</li>
            <li>Adds your chosen <strong>protection</strong> to create an “effective frost date.”</li>
            <li>Subtracts <strong>days to maturity</strong> + your <strong>buffer</strong> to suggest a latest sow date.</li>
          </ul>
        </details>

        <p class="note small" id="ff-error" role="alert" style="display:none;"></p>
        <p class="sr-only" id="ff-status" role="status" aria-live="polite"></p>

        <div class="btnRow" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="button primary" id="calcBtn" type="button">Calculate</button>
          <button class="button" id="resetBtn" type="button">Reset</button>
          <button class="button" id="copyBtn" type="button" style="display:none;">Copy plan</button>
          <button class="button" id="csvBtn" type="button" style="display:none;">Download CSV</button>
          <button class="button" id="txtBtn" type="button" style="display:none;">Download text</button>
          <button class="button" id="printBtn" type="button" style="display:none;">Print</button>
        </div>
      </div>
    </section>

    <section class="card" id="resultsCard" style="display:none;" aria-labelledby="resultsTitle">
      <h2 id="resultsTitle">Results</h2>

      <table aria-label="Fall cutoff results" style="margin-top:0.75rem;">
        <tbody id="resultsBody"></tbody>
      </table>

      <p class="small muted" style="margin-top:10px;">
        If you’re close to the cutoff, choose faster varieties, protect the crop, or aim for “baby” harvests.
      </p>
    </section>

    <section class="card">
      <h2>Short-season notes</h2>
      <ul class="tight">
        <li><strong>Fall growth slows down.</strong> Days to maturity often stretch as nights cool and daylight drops.</li>
        <li><strong>Buffers matter.</strong> A 7–14 day buffer is a practical default for cold-climate planning.</li>
        <li><strong>Protection buys time, not heat.</strong> Row cover and tunnels can push frost risk later, but they don’t make a warm-season crop happy.</li>
        <li><strong>Variety choice is leverage.</strong> If you’re tight on time, pick the fastest days-to-maturity varieties.</li>
      </ul>
    </section>

    <section class="card">
      <h2>Related</h2>
      <ul>
        <li><a href="/tools/seed-start-planner/">Seed Starting Planner</a></li>
      </ul>
    </section>

  </div>
</section>

<script type="application/json" id="siteCropsJson">{{ crops | dump | safe }}</script>

<style>
  /* Keep checkboxes from inheriting full-width input styles */
  .cropList input[type="checkbox"] { width: auto !important; }
  .cropList {
    margin-top: 8px;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 10px;
    padding: 8px;
    max-height: 260px;
    overflow: auto;
    background: rgba(0,0,0,0.02);
  }
  .cropRow {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 8px;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
  }
  .cropRow:hover { background: rgba(0,0,0,0.04); }
  .cropRow + .cropRow { border-top: 1px solid rgba(0,0,0,0.06); }
  .cropRow .cropName { font-weight: 600; }
  .cropRow .cropMeta { margin-left: auto; opacity: 0.75; font-size: 0.9em; }
  .cropHeaderRow td {
    background: rgba(0,0,0,0.04);
    border-top: 1px solid rgba(0,0,0,0.10);
    padding-top: 10px;
  }
  .sepRow td { padding: 0; height: 10px; border: 0; }
  .valueCell { white-space: nowrap; font-variant-numeric: tabular-nums; }
  @media print {
    body * { visibility: hidden; }
    #resultsCard, #resultsCard * { visibility: visible; }
    #resultsCard { position: absolute; left: 0; top: 0; width: 100%; }
    #copyBtn, #csvBtn, #txtBtn, #printBtn { display: none !important; }
  }
</style>

<script>
  // ---- Helpers ----
  const byId = (id) => document.getElementById(id);

  const SITE_CROPS = (() => {
    try {
      const el = document.getElementById("siteCropsJson");
      if (!el) return [];
      return JSON.parse(el.textContent || "[]");
    } catch (e) { return []; }
  })();

  // Only crops that belong to this tool
  const TOOL_SLUG = "first-frost-planner";
  const TOOL_CROPS = (SITE_CROPS || [])
    .filter(c => c && Array.isArray(c.relatedTools) && c.relatedTools.includes(TOOL_SLUG))
    .sort((a, b) => (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: "base" }));

  function toDate(inputValue) {
    if (!inputValue) return null;
    const [y, m, d] = inputValue.split("-").map(Number);
    return new Date(y, m - 1, d, 12, 0, 0, 0); // local noon reduces DST weirdness
  }

  function fmt(date) {
    return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  }

  function addDays(date, days) {
    const out = new Date(date);
    out.setDate(out.getDate() + days);
    return out;
  }

  function getDtmRange(crop) {
    const d = crop && crop.daysToMaturity;
    if (Array.isArray(d) && d.length === 2) return [Number(d[0]), Number(d[1])].sort((a,b)=>a-b);
    if (Number.isFinite(d)) return [Number(d), Number(d)];
    return null;
  }

  function cropUrl(crop) {
    const slug = crop && crop.slug ? crop.slug : (crop && crop.id ? crop.id : "");
    return `/crops/${slug}/`;
  }

  function clearError() {
    const el = byId("ff-error");
    el.style.display = "none";
    el.textContent = "";
  }

  function showError(html) {
    const el = byId("ff-error");
    el.style.display = "block";
    el.innerHTML = html;
  }

  // ---- Crop checkbox list ----
  function initCropList() {
    const wrap = byId("cropList");
    wrap.innerHTML = "";

    for (const c of TOOL_CROPS) {
      const dtm = getDtmRange(c);
      const dtmText = dtm ? `${dtm[0]}–${dtm[1]}d` : "";
      const id = `crop_${c.id}`;

      const row = document.createElement("div");
      row.className = "cropRow";
      row.innerHTML = `
        <input type="checkbox" id="${id}" value="${c.id}" />
        <div>
          <div class="cropName">${c.name}</div>
          <div class="small" style="opacity:0.8;">${(c.indexBlurb || c.tagline || "").toString()}</div>
        </div>
        <div class="cropMeta">${dtmText}</div>
      `;
      row.addEventListener("click", (e) => {
        // allow clicking anywhere on row
        if (e.target && e.target.tagName === "INPUT") return;
        const cb = row.querySelector("input[type='checkbox']");
        cb.checked = !cb.checked;
      });

      wrap.appendChild(row);
    }
  }

  function selectedCropIds() {
    return Array.from(byId("cropList").querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.value);
  }

  // ---- Results table helpers ----
  function addCropHeader(crop) {
    const tr = document.createElement("tr");
    tr.className = "cropHeaderRow";
    tr.innerHTML = `<td colspan="3"><strong><a href="${cropUrl(crop)}">${crop.name}</a></strong></td>`;
    byId("resultsBody").appendChild(tr);
  }

  function addRow(task, value, notes) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="width:38%;"><strong>${task}</strong></td>
      <td class="valueCell" style="width:26%;">${value}</td>
      <td class="muted">${notes || ""}</td>
    `;
    byId("resultsBody").appendChild(tr);
  }

  function addSeparator() {
    const tr = document.createElement("tr");
    tr.className = "sepRow";
    tr.innerHTML = `<td colspan="3"></td>`;
    byId("resultsBody").appendChild(tr);
  }

  // ---- Export helpers ----
  function escapeCsv(value) {
    const s = (value ?? "").toString();
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function buildTextPlan(rows, firstFrost, effectiveFrost, protectionDays, bufferDays) {
    const lines = [];
    lines.push("GrowByDate — First Frost Fall Planner");
    lines.push(`Average first frost: ${fmt(firstFrost)}`);
    lines.push(`Effective frost (with protection): ${fmt(effectiveFrost)} (protection +${protectionDays} days)`);
    lines.push(`Buffer: ${bufferDays} days`);
    lines.push("");

    let currentCrop = "";
    for (const r of rows) {
      if (r.crop !== currentCrop) {
        currentCrop = r.crop;
        lines.push(currentCrop);
        lines.push("-".repeat(currentCrop.length));
      }
      lines.push(`${r.task}: ${r.window}${r.notes ? " — " + r.notes : ""}`);
    }
    return lines.join("\n");
  }

  function downloadBlob(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---- Main calculate ----
  let lastPlanRows = null;
  let lastPlanMeta = null;

  function calculate() {
    clearError();
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
    byId("printBtn").style.display = "none";
    lastPlanRows = null;
    lastPlanMeta = null;

    const firstFrost = toDate(byId("firstFrost").value);
    const protectionDays = parseInt(byId("protection").value, 10) || 0;
    const bufferDays = parseInt(byId("buffer").value, 10) || 0;
    const cropIds = selectedCropIds();

    if (!firstFrost) {
      showError("Please enter an average <strong>first fall frost date</strong> to calculate your cutoff.");
      return;
    }
    if (!cropIds.length) {
      showError("Please select at least <strong>one crop</strong>.");
      return;
    }

    const effectiveFrost = addDays(firstFrost, protectionDays);

    const planRows = [];

    cropIds.forEach((id, idx) => {
      const crop = TOOL_CROPS.find(c => c.id === id);
      if (!crop) return;

      if (idx > 0) addSeparator();
      addCropHeader(crop);

      const dtm = getDtmRange(crop);
      if (!dtm) {
        addRow("Latest recommended sow date", "—", "No days-to-maturity data available for this crop.");
        return;
      }

      const [minDtm, maxDtm] = dtm;
      const conservative = addDays(effectiveFrost, -(maxDtm + bufferDays));
      const fastVariety = addDays(effectiveFrost, -(minDtm + bufferDays));

      const windowText = (minDtm === maxDtm)
        ? fmt(conservative)
        : `${fmt(conservative)} – ${fmt(fastVariety)}`;

      addRow(
        "Latest recommended sow date",
        windowText,
        minDtm === maxDtm
          ? `Uses ${maxDtm} days + ${bufferDays} day buffer.`
          : `Uses ${minDtm}–${maxDtm} days + ${bufferDays} day buffer (fast → slow varieties).`
      );

      addRow(
        "Effective frost date",
        fmt(effectiveFrost),
        protectionDays ? `Based on ${fmt(firstFrost)} + ${protectionDays} days protection.` : `No protection applied.`
      );

      // Crop note (keep it practical)
      const note = (crop.indexBlurb || crop.tagline || crop.notes || "").toString().trim();
      if (note) addRow("Crop note", "—", note);

      // Frost tolerance at bottom
      if (crop.frostTolerance) addRow("Frost tolerance", "—", crop.frostTolerance);

      planRows.push(
        { crop: crop.name, task: "Latest recommended sow date", window: windowText, notes: "" },
        { crop: crop.name, task: "Effective frost date", window: fmt(effectiveFrost), notes: protectionDays ? `Avg first frost ${fmt(firstFrost)} + ${protectionDays}d` : `Avg first frost ${fmt(firstFrost)}` },
      );
    });

    lastPlanRows = planRows;
    lastPlanMeta = { firstFrost, effectiveFrost, protectionDays, bufferDays };

    byId("resultsCard").style.display = "block";
    byId("copyBtn").style.display = "inline-block";
    byId("csvBtn").style.display = "inline-block";
    byId("txtBtn").style.display = "inline-block";
    byId("printBtn").style.display = "inline-block";

    // Scroll to results
    setTimeout(() => {
      const results = byId("resultsCard");
      if (results) results.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 50);
  }

  function resetForm() {
    byId("firstFrost").value = "";
    byId("protection").value = "0";
    byId("buffer").value = "10";
    Array.from(byId("cropList").querySelectorAll("input[type='checkbox']")).forEach(cb => cb.checked = false);
    clearError();
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
    byId("printBtn").style.display = "none";
    lastPlanRows = null;
    lastPlanMeta = null;
  }

  function copyPlan() {
    if (!lastPlanRows || !lastPlanMeta) return;
    const { firstFrost, effectiveFrost, protectionDays, bufferDays } = lastPlanMeta;
    const text = buildTextPlan(lastPlanRows, firstFrost, effectiveFrost, protectionDays, bufferDays);
    navigator.clipboard.writeText(text).catch(() => {});
  }

  function downloadCsv() {
    if (!lastPlanRows) return;
    const lines = [];
    lines.push(["Crop","Task","Recommended window","Notes"].map(escapeCsv).join(","));
    for (const r of lastPlanRows) {
      lines.push([r.crop, r.task, r.window, r.notes].map(escapeCsv).join(","));
    }
    downloadBlob("growbydate-fall-plan.csv", lines.join("\n"), "text/csv;charset=utf-8");
  }

  function downloadText() {
    if (!lastPlanRows || !lastPlanMeta) return;
    const { firstFrost, effectiveFrost, protectionDays, bufferDays } = lastPlanMeta;
    const text = buildTextPlan(lastPlanRows, firstFrost, effectiveFrost, protectionDays, bufferDays);
    downloadBlob("growbydate-fall-plan.txt", text, "text/plain;charset=utf-8");
  }

  function printResults() { window.print(); }

  initCropList();
  byId("calcBtn").addEventListener("click", calculate);
  byId("resetBtn").addEventListener("click", resetForm);
  byId("copyBtn").addEventListener("click", copyPlan);
  byId("csvBtn").addEventListener("click", downloadCsv);
  byId("txtBtn").addEventListener("click", downloadText);
  byId("printBtn").addEventListener("click", printResults);
</script>
