
<section class="section">
  <div id="first-frost-planner" class="toolRoot">

<section class="card" aria-labelledby="ff-title">
      <header>
        <h2 id="ff-title" class="sr-only">First frost planner</h2>
        <p class="small" style="opacity:0.86;">
        <p class="muted">
  Plan fall planting by working backward from your average first frost date (32¬∞F / 0¬∞C).
  You can enter a date directly, or look it up with a ZIP / postal code.
        </p>
      </header>

      <div role="form" aria-describedby="ff-assumptions">
        <div style="margin-top:10px;">
          <h3 class="h4" style="margin:0 0 6px 0;">Start Here</h3>
          <label for="frost-lookup-input">Find my frost date (ZIP / postal code)</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
            <input type="text" id="frost-lookup-input" placeholder="ZIP or Postal Code" autocomplete="postal-code">
            <button id="lookup-btn" type="button">Find</button>
          </div>
          <div id="lookup-result" style="margin-top:10px;"></div>
        </div>

        <div style="margin-top:10px;">
          <label for="firstFrost">Average first fall frost date</label>
          <div class="small" id="firstFrostHelp"></div>
          <input id="firstFrost" type="date" aria-describedby="firstFrostHelp ff-error" />
        </div>

        <div style="margin-top:10px;">
          <label>Crops</label>
          <div class="small" id="cropHelp">Select one or more crops to calculate fall cutoffs.</div>
          <div id="cropList" class="cropList" aria-describedby="cropHelp"></div>
        </div>

        <div style="margin-top:10px;">
          <label for="protection">Season extension</label>
          <div class="small" id="protectionHelp">Shifts your effective frost date later by ~1‚Äì2 weeks.</div>
          <select id="protection" aria-describedby="protectionHelp">
            <option value="0">None</option>
            <option value="7">Light protection (row cover / cloche) ‚Äî ~1 week</option>
            <option value="14">Stronger protection (tunnel / cold frame) ‚Äî ~2 weeks</option>
          </select>
        </div>

        <div style="margin-top:10px;">
          <label for="buffer">Safety buffer</label>
          <div class="small" id="bufferHelp">Accounts for slower fall growth, cool soil, and harvest delays.</div>
          <select id="buffer" aria-describedby="bufferHelp">
            <option value="7">Conservative (7 days)</option>
            <option value="10" selected>Standard (10 days)</option>
            <option value="14">Extra cautious (14 days)</option>
            <option value="0">None</option>
          </select>
        </div>

        <p class="note small" id="ff-error" role="alert" style="display:none;"></p>
        <p class="sr-only" id="ff-status" role="status" aria-live="polite"></p>

        <div class="btnRow" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="button primary" id="calcBtn" type="button">Calculate</button>
          <button class="button" id="resetBtn" type="button">Reset</button>
        </div>
</div>
    </section>

    <section class="card" id="resultsCard" style="display:none;" aria-labelledby="resultsTitle">
      <h2 id="resultsTitle">Results</h2>

      <table aria-label="Fall cutoff results" style="margin-top:0.75rem;">
        <tbody id="resultsBody"></tbody>
      </table>

      <div id="resultsActions" style="margin-top:12px;">
        <button class="btn" id="copyBtn" type="button" style="display:none;">Copy plan</button>
        <button class="btn" id="printBtn" type="button" style="display:none;">Print</button>
        <button class="btn" id="csvBtn" type="button" style="display:none;">Download CSV</button>
        <button class="btn" id="txtBtn" type="button" style="display:none;">Download text</button>
      </div>

      <p class="small muted" style="margin-top:10px;">
        If you‚Äôre close to the cutoff, choose faster varieties, protect the crop, or aim for ‚Äúbaby‚Äù harvests.
      </p>
    </section>

    <section class="card">

  <h2>How This Planner Works</h2>

  <p class="muted" style="margin-top:0;">

        <div style="margin-top:14px;">
          <div class="muted" style="margin-bottom:14px;">
            <div class="pill">1</div>
            <p style="margin:6px 0 0;"><strong>Enter your first frost date</strong></p>
            <p class="small" style="margin:6px 0 0;">
              Use your <strong>average</strong> first fall frost date to plan. This tool counts backward from that anchor.
            </p>
          </div>

          <div class="muted" style="margin-bottom:14px;">
            <div class="pill">2</div>
            <p style="margin:6px 0 0;"><strong>Choose one or more crops</strong></p>
            <p class="small" style="margin:6px 0 0;">
              Each crop uses its typical <strong>days to maturity</strong> plus a safety buffer to estimate a fall cutoff.
            </p>
          </div>

          <div class="muted" style="margin-bottom:14px;">
            <div class="pill">3</div>
            <p style="margin:6px 0 0;"><strong>Set buffer and protection</strong></p>
            <p class="small" style="margin:6px 0 0;">
              Buffer adds breathing room. Season protection shifts your effective frost date later (row cover / tunnel / cold frame).
            </p>
          </div>

          <div class="muted" style="margin-bottom:14px;">
            <div class="pill">4</div>
            <p style="margin:6px 0 0;"><strong>Read the cutoff dates correctly</strong></p>
            <p class="small" style="margin:6px 0 0;">
              These are planning cutoffs, not guarantees. If nights cool early, growth slows and your true window shrinks.
            </p>
          </div>
        </div>

        <p class="small muted" style="margin-top:6px;" id="ff-quickcheck">
          Quick check: fall success depends on daylight and night temperatures. Frost dates guide planning ‚Äî your yard decides final timing.
        </p>
        </section>

    <section class="card">
      <h2>Short-season notes</h2>
      <ul class="tight">
        <li><strong>Fall growth slows down.</strong> Days to maturity often stretch as nights cool and daylight drops.</li>
        <li><strong>Buffers matter.</strong> A 7‚Äì14 day buffer is a practical default for cold-climate planning.</li>
        <li><strong>Protection buys time, not heat.</strong> Row cover and tunnels can push frost risk later, but they don‚Äôt make a warm-season crop happy.</li>
        <li><strong>Variety choice is leverage.</strong> If you‚Äôre tight on time, pick the fastest days-to-maturity varieties.</li>
      </ul>
    </section>

  </div>
</section>

<script type="application/json" id="siteCropsJson">{{ crops | dump | safe }}</script>

<style>
  .grid { display: grid; gap: 14px; }

  .row { display: grid; gap: 10px; grid-template-columns: 1fr; }

  /* Prevent grid children from overflowing their column (fixes date input ‚Äúspill‚Äù) */
  .row > div { min-width: 0; }

  label { font-weight: 600; }

  input[type="date"], input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 12px;
    font: inherit;
    box-sizing: border-box;
  }

  /* Extra safety for the frost date field specifically */
  #firstFrost { min-width: 0; max-width: 100%; }

  .small { font-size: 14px; opacity: .85; }
  .card + .card { margin-top: 14px; }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #e5e5e5; text-align: left; vertical-align: top; }
  th { font-weight: 700; }

  .pill { display: inline-block; padding: 2px 8px; border: 1px solid #222; border-radius: 999px; font-size: 12px; opacity: .9; }

  .warn { border: 1px solid #e3c46b; border-radius: 12px; padding: 10px 12px; background: #fff8e1; }
 .muted { color: rgba(0, 0, 0, 0.75); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border: 1px solid #111;
    border-radius: 12px;
    background: transparent;
    cursor: pointer;
    font: inherit;
    line-height: 1.2;
    white-space: nowrap;
    box-sizing: border-box;
  }
  .btn:hover { opacity: .85; }

  .btnRow { display:flex; align-items:end; gap:10px; flex-wrap: wrap; }

  /* If your primary action uses .button / .button.primary, normalize it to match .btn */
  .btnRow .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 12px;
    font: inherit;
    line-height: 1.2;
    white-space: nowrap;
    box-sizing: border-box;
  }

  .content { max-width: 760px; }

  .faq details { border: 1px solid #e8e8e8; border-radius: 12px; padding: 10px 12px; background: #fff; }
  .faq details + details { margin-top: 10px; }
  .faq summary { cursor: pointer; font-weight: 650; }

  .breadcrumbs { font-size: 14px; opacity: .85; margin-bottom: 10px; }
  .breadcrumbs a { text-decoration: none; }

  .linkRow { display:flex; gap:10px; flex-wrap: wrap; }
  .linkRow a { text-decoration: none; border-bottom: 1px solid currentColor; }

  .noteIcon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  line-height: 1;
}

#resultsBody svg {
  display: inline-block;
  vertical-align: middle;
  opacity: .85;
}

#resultsBody td.muted {
  opacity: 1;
  color: rgba(0, 0, 0, 0.75);
}

.noteIcon svg {
  display: inline-block;
  vertical-align: middle;
  opacity: .85;
}

/* Keep planner text ‚Äúmuted‚Äù without fading emoji/icons */
#resultsCard .muted,
#resultsCard .small {
  opacity: 1;
}

#resultsCard .muted {
  color: rgba(0, 0, 0, 0.75);
}


/* Print: only print the results card */
@media print {
  /* Hide everything by default */
  body * { visibility: hidden !important; }

  /* Show results */
  #resultsCard, #resultsCard * { visibility: visible !important; }

  /* Position results at top-left for printing */
  #resultsCard {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    display: block !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* Hide interactive controls inside results */
  #resultsActions { display: none !important; }
}


  /* Crop checklist */
.cropList {
  border: 1px solid var(--border, #ddd);
  border-radius: 10px;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px 10px;     /* row gap, column gap */
  max-height: none;  /* remove internal scroll */
  overflow: visible;
}
  .cropPickRow { margin: 0; }
  .cropPickLabel:hover { background: rgba(0,0,0,0.04); }
  .cropPickLabel input { flex: 0 0 auto; }
.cropPickName {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.cropPickLabel {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 999px;
  cursor: pointer;
  user-select: none;
  border: 1px solid rgba(0,0,0,0.10);
  background: rgba(0,0,0,0.02);
}

/* Remove the full-width stacking */
.cropPickLabel { width: auto; }

  /* Multi-crop clarity in results */
  .cropHeaderRow td { padding: 10px 12px; background: rgba(0,0,0,0.04); border-top: 1px solid rgba(0,0,0,0.08); }
  .cropHeaderRow:first-child td { border-top: 0; }
  .cropHeaderIcon { margin-right: 8px; }
  .cropHeaderLink { font-weight: 700; text-decoration: none; }
  .cropHeaderLink:hover { text-decoration: underline; }
  .cropSeparatorRow td { padding: 0; height: 10px; background: transparent; }


  /* Date range readability */
  .dateRange {
    display: inline-flex;
    align-items: baseline;
    gap: .35rem;
    font-variant-numeric: tabular-nums;
    letter-spacing: .2px;
    white-space: nowrap;
    background: rgba(0,0,0,0.035);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 10px;
    padding: 2px 8px;
  }
  .dateRange .date { font-weight: 400; }
  .dateRange .rangeSep { opacity: .65; }
</style>

<script>
  // ---- Helpers ----
  const byId = (id) => document.getElementById(id);

  const SITE_CROPS = (() => {
    try {
      const el = document.getElementById("siteCropsJson");
      if (!el) return [];
      return JSON.parse(el.textContent || "[]");
    } catch (e) { return []; }
  })();

  // Only crops that belong to this tool
  const TOOL_SLUG = "first-frost-planner";
  const TOOL_CROPS = (SITE_CROPS || [])
    .filter(c => c && Array.isArray(c.relatedTools) && c.relatedTools.includes(TOOL_SLUG))
    .sort((a, b) => (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: "base" }));


    function cropIcon(id) {
    const icons = {
      tomato: "üçÖ",
      tomatoes: "üçÖ",
      pepper: "ü´ë",
      peppers: "ü´ë",
      cucumber: "ü•í",
      cucumbers: "ü•í",
      zucchini: "ü•í",
      bean: "ü´ò",
      beans: "ü´ò",
      lettuce: "ü•¨",
      spinach: "üçÉ",
      kale: "ü•¨",
      broccoli: "ü•¶",
      cabbage: "ü•¨",
      carrot: "ü•ï",
      carrots: "ü•ï",
      beet: "üü£",
      beets: "üü£",
      pea: "üü¢",
      peas: "üü¢",
      onion: "üßÖ",
      onions: "üßÖ",
      garlic: "üßÑ",
      radish: "üî¥",
      radishes: "üî¥",
      "swiss-chard": "ü•¨",
      cauliflower: "ü•¶",
      "winter-squash": "üéÉ",
      potato: "ü•î"
    };
    return icons[id] || "üå±";
  }
  function toDate(inputValue) {
    if (!inputValue) return null;
    const [y, m, d] = inputValue.split("-").map(Number);
    return new Date(y, m - 1, d, 12, 0, 0, 0); // local noon reduces DST weirdness
  }

  function fmt(date) {
    return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  }


  function fmtRange(start, end) {
    return `<span class="dateRange"><span class="date">${fmt(start)}</span><span class="rangeSep">‚Üí</span><span class="date">${fmt(end)}</span></span>`;
  }

  function fmtSingle(date) {
    return `<span class="dateRange"><span class="date">${fmt(date)}</span></span>`;
  }
  function addDays(date, days) {
    const out = new Date(date);
    out.setDate(out.getDate() + days);
    return out;
  }

  function getDtmRange(crop) {
    const d = crop && crop.daysToMaturity;
    if (Array.isArray(d) && d.length === 2) return [Number(d[0]), Number(d[1])].sort((a,b)=>a-b);
    if (Number.isFinite(d)) return [Number(d), Number(d)];
    return null;
  }

  function cropUrl(crop) {
    const slug = crop && crop.slug ? crop.slug : (crop && crop.id ? crop.id : "");
    return `/crops/${slug}/`;
  }

  function clearError() {
    const el = byId("ff-error");
    el.style.display = "none";
    el.textContent = "";
  }

  function showError(html) {
    const el = byId("ff-error");
    el.style.display = "block";
    el.innerHTML = html;
  }

  // ---- Crop checkbox list ----
  function initCropList() {
    const wrap = byId("cropList");
    wrap.innerHTML = "";

    for (const c of TOOL_CROPS) {
      const dtm = getDtmRange(c);
      const dtmText = dtm ? `${dtm[0]}‚Äì${dtm[1]}d` : "";
      const id = `crop_${c.id}`;

      const row = document.createElement("div");
      row.className = "cropPickRow";
      row.innerHTML = `
        <label class="cropPickLabel" for="${id}">
          <input type="checkbox" id="${id}" value="${c.id}" />
          <span class="cropPickName">
            <span class="cropPickIcon" aria-hidden="true">${cropIcon(c.id)}</span>
            <span>${c.name}</span>
          </span>
          <span class="small muted" style="margin-left:auto; white-space:nowrap;">${dtmText}</span>
        </label>
      `;
      wrap.appendChild(row);
    }
  }

  function selectedCropIds() {
    return Array.from(byId("cropList").querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.value);
  }

  // ---- Results table helpers ----
  function addCropHeader(crop) {
    const tr = document.createElement("tr");
    tr.className = "cropHeaderRow";
    tr.innerHTML = `
      <td colspan="3">
        <span class="cropHeaderIcon" aria-hidden="true">${cropIcon(crop.id)}</span>
        <a class="cropHeaderLink" href="${cropUrl(crop)}">${crop.name}</a>
      </td>`;
    byId("resultsBody").appendChild(tr);
  }

  function addRow(task, value, notes) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="width:38%;"><strong>${task}</strong></td>
      <td class="valueCell" style="width:26%;">${value}</td>
      <td class="muted">${notes || ""}</td>
    `;
    byId("resultsBody").appendChild(tr);
  }

  function addRowSpan(task, content) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="width:38%;"><strong>${task}</strong></td>
      <td class="muted" colspan="2">${content || ""}</td>
    `;
    byId("resultsBody").appendChild(tr);
  }


  function addSeparator() {
    const tr = document.createElement("tr");
    tr.className = "cropSeparatorRow";
    tr.innerHTML = `<td colspan="3"></td>`;
    byId("resultsBody").appendChild(tr);
  }

  // ---- Export helpers ----
  function escapeCsv(value) {
    const s = (value ?? "").toString();
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function buildTextPlan(rows, firstFrost, effectiveFrost, protectionDays, bufferDays) {
    const lines = [];
    lines.push("GrowByDate ‚Äî First Frost Fall Planner");
    lines.push(`Average first frost: ${fmt(firstFrost)}`);
    lines.push(`Effective frost (with protection): ${fmt(effectiveFrost)} (protection +${protectionDays} days)`);
    lines.push(`Buffer: ${bufferDays} days`);
    lines.push("");

    let currentCrop = "";
    for (const r of rows) {
      if (r.crop !== currentCrop) {
        currentCrop = r.crop;
        lines.push(currentCrop);
        lines.push("-".repeat(currentCrop.length));
      }
      lines.push(`${r.task}: ${r.window}${r.notes ? " ‚Äî " + r.notes : ""}`);
    }
    return lines.join("\n");
  }

  function downloadBlob(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---- Main calculate ----
  let lastPlanRows = null;
  let lastPlanMeta = null;

  function calculate() {
    clearError();
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
    byId("printBtn").style.display = "none";
    lastPlanRows = null;
    lastPlanMeta = null;

    const firstFrost = toDate(byId("firstFrost").value);
    const protectionDays = parseInt(byId("protection").value, 10) || 0;
    const bufferDays = parseInt(byId("buffer").value, 10) || 0;
    const cropIds = selectedCropIds();

    if (!firstFrost) {
      showError("Please enter an average <strong>first fall frost date</strong> to calculate your cutoff.");
      return;
    }
    if (!cropIds.length) {
      showError("Please select at least <strong>one crop</strong>.");
      return;
    }

    const effectiveFrost = addDays(firstFrost, protectionDays);

    const planRows = [];

    cropIds.forEach((id, idx) => {
      const crop = TOOL_CROPS.find(c => c.id === id);
      if (!crop) return;

      if (idx > 0) addSeparator();
      addCropHeader(crop);

      const dtm = getDtmRange(crop);
      if (!dtm) {
        addRow("Latest recommended sow date", "‚Äî", "No days-to-maturity data available for this crop.");
        return;
      }

      const [minDtm, maxDtm] = dtm;
      const conservative = addDays(effectiveFrost, -(maxDtm + bufferDays));
      const fastVariety = addDays(effectiveFrost, -(minDtm + bufferDays));

      const windowTextPlain = (minDtm === maxDtm)
        ? fmt(conservative)
        : `${fmt(conservative)} ‚Äì ${fmt(fastVariety)}`;

      const windowText = (minDtm === maxDtm)
        ? fmtSingle(conservative)
        : fmtRange(conservative, fastVariety);

      addRow(
        "Latest recommended sow date",
        windowText,
        minDtm === maxDtm
          ? `Uses ${maxDtm} days + ${bufferDays} day buffer.`
          : `Uses ${minDtm}‚Äì${maxDtm} days + ${bufferDays} day buffer (fast ‚Üí slow varieties).`
      );

      addRow(
        "Effective frost date",
        fmtSingle(effectiveFrost),
        protectionDays ? `Based on ${fmt(firstFrost)} + ${protectionDays} days protection.` : `No protection applied.`
      );

      // Crop note (keep it practical)
      const note = (crop.indexBlurb || crop.tagline || crop.notes || "").toString().trim();
      if (note) {
        addRowSpan("Crop note", note);
        planRows.push({ crop: crop.name, task: "Crop note", window: note, notes: "" });
      }

      // Frost tolerance at bottom
      if (crop.frostTolerance) {
        addRowSpan("Frost tolerance", crop.frostTolerance);
        planRows.push({ crop: crop.name, task: "Frost tolerance", window: crop.frostTolerance, notes: "" });
      }
planRows.push(
        { crop: crop.name, task: "Latest recommended sow date", window: windowTextPlain, notes: "" },
        { crop: crop.name, task: "Effective frost date", window: fmt(effectiveFrost), notes: protectionDays ? `Avg first frost ${fmt(firstFrost)} + ${protectionDays}d` : `Avg first frost ${fmt(firstFrost)}` },
      );
    });

    lastPlanRows = planRows;
    lastPlanMeta = { firstFrost, effectiveFrost, protectionDays, bufferDays };

    byId("resultsCard").style.display = "block";
    byId("copyBtn").style.display = "inline-block";
    byId("csvBtn").style.display = "inline-block";
    byId("txtBtn").style.display = "inline-block";
    byId("printBtn").style.display = "inline-block";

    // Scroll to results
    setTimeout(() => {
      const results = byId("resultsCard");
      if (results) results.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 50);
  }

  function resetForm() {
    byId("firstFrost").value = "";
    byId("protection").value = "0";
    byId("buffer").value = "10";
    Array.from(byId("cropList").querySelectorAll("input[type='checkbox']")).forEach(cb => cb.checked = false);
    clearError();
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
    byId("printBtn").style.display = "none";
    lastPlanRows = null;
    lastPlanMeta = null;
  }

  function copyPlan() {
    if (!lastPlanRows || !lastPlanMeta) return;
    const { firstFrost, effectiveFrost, protectionDays, bufferDays } = lastPlanMeta;
    const text = buildTextPlan(lastPlanRows, firstFrost, effectiveFrost, protectionDays, bufferDays);
    navigator.clipboard.writeText(text).catch(() => {});
  }

  function downloadCsv() {
    if (!lastPlanRows) return;
    const lines = [];
    lines.push(["Crop","Task","Recommended window","Notes"].map(escapeCsv).join(","));
    for (const r of lastPlanRows) {
      lines.push([r.crop, r.task, r.window, r.notes].map(escapeCsv).join(","));
    }
    downloadBlob("growbydate-fall-plan.csv", lines.join("\n"), "text/csv;charset=utf-8");
  }

  function downloadText() {
    if (!lastPlanRows || !lastPlanMeta) return;
    const { firstFrost, effectiveFrost, protectionDays, bufferDays } = lastPlanMeta;
    const text = buildTextPlan(lastPlanRows, firstFrost, effectiveFrost, protectionDays, bufferDays);
    downloadBlob("growbydate-fall-plan.txt", text, "text/plain;charset=utf-8");
  }

  function printResults() { window.print(); }

  initCropList();
  byId("calcBtn").addEventListener("click", calculate);
  byId("resetBtn").addEventListener("click", resetForm);
  byId("copyBtn").addEventListener("click", copyPlan);
  byId("csvBtn").addEventListener("click", downloadCsv);
  byId("txtBtn").addEventListener("click", downloadText);
  byId("printBtn").addEventListener("click", printResults);
</script>

<script type="module">
  import {
    lookupFrost,
    populateDateInput,
    renderResultCard,
    buildPlannerLink,
    applyQueryPrefill
  } from "/assets/js/frost-lookup.js";

  const firstFrostInput = document.getElementById("firstFrost");
  const input = document.getElementById("frost-lookup-input");
  const btn = document.getElementById("lookup-btn");
  const out = document.getElementById("lookup-result");

  function runPlanner() {
    const calcBtn = document.getElementById("calcBtn");
    if (calcBtn) calcBtn.click();
  }

  async function doLookup() {
    if (!input || !out) return;
    const frost = await lookupFrost(input.value);

    renderResultCard(out, frost);


    if (frost && firstFrostInput) {
      populateDateInput(firstFrostInput, frost.firstFrost);
      
      // Keep the top reference clean: bring the First frost date field to the top of the viewport.
      const firstFrostLabel = document.querySelector('label[for="firstFrost"]') || firstFrostInput;
      if (firstFrostLabel) {
        const y = firstFrostLabel.getBoundingClientRect().top + window.scrollY - 80;
        window.scrollTo({ top: y, behavior: "smooth" });
      }
runPlanner();
    }
  }

  if (btn) btn.addEventListener("click", doLookup);
  if (input) input.addEventListener("keydown", (e) => { if (e.key === "Enter") doLookup(); });

  // Query param prefill: ?firstFrost=MM-DD
  applyQueryPrefill("firstFrost", firstFrostInput, () => runPlanner());
</script>
