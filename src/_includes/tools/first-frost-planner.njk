
    <section class="card" aria-labelledby="ff-title">
      <header>
        <h2 id="ff-title">First frost → fall planting window</h2>
        <p class="small" style="opacity:0.86;">
          Enter your <strong>average first fall frost date</strong>. This tool counts backward using days to maturity + your buffer.
        </p>
      </header>

      <div class="grid" role="form" aria-describedby="ff-assumptions">
        <div class="row">
          <div>
            <label for="firstFrost"><strong>Average first fall frost date</strong></label>
            <input id="firstFrost" type="date" aria-describedby="firstFrostHelp ff-error" />
            <div class="small" id="firstFrostHelp">Use the typical first frost for your area (not the earliest ever).</div>
          </div>

          <div>
            <label for="crop"><strong>Crop</strong></label>
            <select id="crop" aria-describedby="cropHelp"></select>
            <div class="small" id="cropHelp">Days to maturity are typical ranges. Variety and fall conditions can shift timing.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="protection"><strong>Season extension</strong></label>
            <select id="protection" aria-describedby="protectionHelp">
              <option value="0">None</option>
              <option value="7">Light protection (row cover / cloche) — ~1 week</option>
              <option value="14">Stronger protection (tunnel / cold frame) — ~2 weeks</option>
            </select>
            <div class="small" id="protectionHelp">Shifts your effective frost date later by ~1–2 weeks.</div>
          </div>

          <div>
            <label for="buffer"><strong>Safety buffer</strong></label>
            <select id="buffer" aria-describedby="bufferHelp">
              <option value="7">Conservative (7 days)</option>
              <option value="10" selected>Standard (10 days)</option>
              <option value="14">Extra cautious (14 days)</option>
              <option value="0">None</option>
            </select>
            <div class="small" id="bufferHelp">Accounts for slower fall growth, cool soil, and harvest delays.</div>
          </div>
        </div>

        <details class="note small" id="ff-assumptions" style="opacity:0.9;">
          <summary><span class="pill">Assumptions</span> What this tool is doing</summary>
          <ul class="tight" style="margin:0.5rem 0 0 1.25rem;">
            <li>Counts backward from your <strong>average first frost</strong>.</li>
            <li>Adds your chosen <strong>protection</strong> to create an “effective frost date.”</li>
            <li>Subtracts <strong>days to maturity</strong> + your <strong>buffer</strong> to suggest a latest sow date.</li>
          </ul>
        </details>

        <p class="note small" id="ff-error" role="alert" style="display:none;"></p>
        <p class="sr-only" id="ff-status" role="status" aria-live="polite"></p>

        <div class="btnRow">
          <button class="button primary" id="calcBtn" type="button">Calculate planting window</button>
          <button class="button" id="resetBtn" type="button">Reset</button>
          <button class="button" id="printBtn" type="button" style="display:none;">Print results</button>
        </div>
      </div>
    </section>

    <section class="card" id="resultsCard" style="display:none;" aria-labelledby="resultsTitle">
      <h2 id="resultsTitle">Results</h2>

      <div class="note" id="confidenceBox" role="note" aria-labelledby="confidenceTitle">
        <div class="pill" id="confidenceTitle">Frost timing confidence</div>
        <div id="confidenceText" class="small" style="margin-top:0.35rem; opacity:0.95;"></div>
        <div id="confidenceHelp" class="small" style="margin-top:0.35rem; opacity:0.82;"></div>
      </div>

      <div class="grid" style="margin-top:0.75rem;">
        <div class="row">
          <div class="note">
            <div class="small" style="opacity:0.85;">Latest recommended sow date</div>
            <div id="outLastSow" style="font-size:1.15rem; font-weight:700; margin-top:0.15rem;">—</div>
            <div class="small" style="opacity:0.82;">Aim to sow on or before this date.</div>
          </div>

          <div class="note">
            <div class="small" style="opacity:0.85;">Effective frost date</div>
            <div id="outEffectiveFrost" style="font-size:1.05rem; font-weight:700; margin-top:0.15rem;">—</div>
            <div id="outEffectiveNote" class="small" style="opacity:0.82;"></div>
          </div>
        </div>
      </div>

      <table aria-label="Calculation details" style="margin-top:0.75rem;">
        <thead>
          <tr>
            <th>Detail</th>
            <th>Value</th>
            <th>What this means</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>

      <div class="note small" style="opacity:0.86; margin-top:0.75rem;">
        <span class="pill">Planning tip</span>
        If you’re close to the cutoff, choose faster varieties or use protection.
      </div>

      <div class="note small" style="opacity:0.86; margin-top:0.75rem;">
        <span class="pill">More</span>
        <a href="/crops/">Browse crops</a> •
        <a href="/tools/seed-start-planner/">Seed starting planner</a>
      </div>
    </section>

    <section class="card">
      <h2>How this works</h2>
      <p>
        We start with your <strong>average first fall frost date</strong>. Then we adjust it by any season protection you select.
        From that “effective frost date,” we subtract your crop’s typical days to maturity plus a safety buffer.
      </p>
      <p class="small" style="opacity:0.82;">
        This is a planning tool, not a guarantee. Weather swings, variety choice, and fall light levels can shift results.
      </p>
    </section>

    <section class="card">
      <h2>Related</h2>
      <ul>
        <li><a href="/tools/seed-start-planner.html">Seed Starting Planner</a></li>
        <li><a href="/guides/seed-starting-short-season.html">Seed starting method for short seasons (guide)</a></li>
      </ul>
    </section>

    <footer class="footer">
      <p><a href="/">← Back to GrowByDate</a></p>
    </footer>
  </main>

  <script type="application/json" id="siteCropsJson">{{ crops | dump | safe }}</script>
<script>
    // Notes:
    // - days: typical days to maturity (rough planning)
    // - hardy: true means it tolerates light frosts better (still slows down in cold)
    const CROPS = [
      { id: "radish",   name: "Radishes",      days: 30, hardy: true,  notes: "Fast and forgiving. Great late-season choice." },
      { id: "spinach",  name: "Spinach",       days: 45, hardy: true,  notes: "Cold-hardy, but can stall in deep cold." },
      { id: "lettuce",  name: "Lettuce",       days: 50, hardy: true,  notes: "Handles cool weather well; protect from hard freezes." },
      { id: "arugula",  name: "Arugula",       days: 35, hardy: true,  notes: "Quick harvest. Can handle cool nights." },
      { id: "kale",     name: "Kale",          days: 60, hardy: true,  notes: "Very cold-tolerant; quality improves after light frosts." },
      { id: "bokchoy",  name: "Bok choy",      days: 45, hardy: true,  notes: "Fast fall crop; watch for bolting in heat." },
      { id: "beet",     name: "Beets",         days: 60, hardy: true,  notes: "Roots size up slower in cold; buffer helps." },
      { id: "carrot",   name: "Carrots",       days: 70, hardy: true,  notes: "Slower to mature; consider smaller/faster varieties." },
      { id: "broccoli", name: "Broccoli",      days: 75, hardy: true,  notes: "Can work, but is close in short falls—variety choice matters." },
      { id: "beans",    name: "Bush beans",    days: 55, hardy: false, notes: "Not frost-tolerant. Needs warmth and time." }
    ];

// Crop metadata from Eleventy data (crops.json). Used for crop page links.
const CROP_ID_ALIASES = {
  tomato: "tomatoes",
  pepper: "peppers",
  carrot: "carrots",
  beet: "beets",
};

const SITE_CROPS_BY_ID = Object.create(null);
const SITE_CROPS_BY_SLUG = Object.create(null);

(function initSiteCropMaps() {
  const el = document.getElementById("siteCropsJson");
  if (!el) return;
  try {
    const arr = JSON.parse(el.textContent || "[]");
    for (const c of arr) {
      if (c && c.id) SITE_CROPS_BY_ID[c.id] = c;
      if (c && c.slug) SITE_CROPS_BY_SLUG[c.slug] = c;
    }
  } catch (e) {
    // If parsing fails, we fall back to tool IDs for links.
  }
})();

function resolveCropMeta(cropId) {
  const normalized = CROP_ID_ALIASES[cropId] || cropId;
  return SITE_CROPS_BY_ID[normalized] || SITE_CROPS_BY_SLUG[normalized] || null;
}


    const byId = (id) => document.getElementById(id);

    function setError(msg) {
      const el = byId("ff-error");
      if (!el) return;
      if (!msg) {
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.textContent = msg;
    }

    function setStatus(msg) {
      const el = byId("ff-status");
      if (el) el.textContent = msg || "";
    }

    function cropUrl(cropId) {
      const meta = resolveCropMeta(cropId);
      const slug = meta && meta.slug ? meta.slug : (CROP_ID_ALIASES[cropId] || cropId);
      return `/crops/${slug}/`;
    }


    function initCropSelect() {
      const sel = byId("crop");
      sel.innerHTML = "";
      for (const c of CROPS) {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        sel.appendChild(opt);
      }
    }

    function toDate(inputValue) {
      if (!inputValue) return null;
      const [y, m, d] = inputValue.split("-").map(Number);
      return new Date(y, m - 1, d, 12, 0, 0, 0); // local noon to reduce DST issues
    }

    function addDays(date, days) {
      const out = new Date(date);
      out.setDate(out.getDate() + days);
      return out;
    }

    function fmt(date) {
      return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function addRow(item, result, notes) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${item}</strong></td>
        <td>${result}</td>
        <td style="opacity:0.85;">${notes || ""}</td>
      `;
      byId("resultsBody").appendChild(tr);
    }

    function confidenceLabel(daysMargin, hardy) {
      // Margin is how many days you have AFTER maturity+buffer before frost.
      // More margin = higher confidence.
      if (daysMargin >= 14) return { cls: "ok",  title: "High confidence:", text: "You have a comfortable buffer before frost." };
      if (daysMargin >= 7)  return { cls: "warn", title: "Medium confidence:", text: "This is workable, but variety choice and protection may matter." };
      // If hardy, small negative margins can still be plausible with protection/harvest stages
      if (hardy && daysMargin >= -3) return { cls: "warn", title: "Borderline", text: "Close to frost. Consider protection and fast varieties." };
      return { cls: "risk", title: "Low confidence:", text: "This is likely too tight for reliable maturity in most short seasons." };
    }

    function calculate() {
      const firstFrost = toDate(byId("firstFrost").value);
      const protectionDays = parseInt(byId("protection").value, 10) || 0;
      const bufferDays = parseInt(byId("buffer").value, 10) || 0;
      const crop = CROPS.find(c => c.id === byId("crop").value);

      byId("resultsBody").innerHTML = "";
      byId("printBtn").style.display = "none";
      byId("resultsCard").style.display = "none";

      setError("");
      setStatus("");

      if (!firstFrost) {
        setError("Please enter an average first fall frost date.");
        setStatus("Missing frost date.");
        return;
      }

      const effectiveFrost = addDays(firstFrost, protectionDays);
      const lastSow = addDays(effectiveFrost, -(crop.days + bufferDays));

      // If you sow on "lastSow", maturity lands at:
      const maturityDate = addDays(lastSow, crop.days);
      const daysMargin = Math.round((effectiveFrost - maturityDate) / (1000 * 60 * 60 * 24));

      const conf = confidenceLabel(daysMargin, crop.hardy);
      const box = byId("confidenceBox");
      box.className = `note ${conf.cls}`;
      const t = byId("confidenceText");
      const h = byId("confidenceHelp");
      if (t) t.textContent = `${conf.title} ${conf.text}`;
      if (h) {
        h.textContent =
          conf.cls === "ok"  ? "Still plan for weather variation—earlier sowing is usually easier." :
          conf.cls === "warn"? "If you’re close, choose faster varieties or use protection." :
                               "Consider a faster crop, earlier sowing, or stronger protection.";
      }



      // Quick-scan summary
      const outLastSow = byId("outLastSow");
      if (outLastSow) outLastSow.textContent = fmt(lastSow);

      const outEffectiveFrost = byId("outEffectiveFrost");
      if (outEffectiveFrost) outEffectiveFrost.textContent = fmt(effectiveFrost);

      const outEffectiveNote = byId("outEffectiveNote");
      if (outEffectiveNote) {
        outEffectiveNote.textContent = protectionDays
          ? `Includes ~${protectionDays} days of protection.`
          : "No protection applied.";
      }
      addRow("Crop", `<a href="${cropUrl(crop.id)}">${crop.name}</a>`, crop.notes);
      addRow("Average first frost date", fmt(firstFrost), "Your input.");
      addRow("Effective frost date", fmt(effectiveFrost), protectionDays ? `Includes ~${protectionDays} days of protection.` : "No protection applied.");
      addRow("Safety buffer", `${bufferDays} days`, "Extra time to account for slower fall growth.");
      addRow("Latest recommended sow date", fmt(lastSow), "Aim to sow on or before this date for the best chance to finish.");
      addRow("Estimated maturity date (if sown on the latest date)", fmt(maturityDate), "Actual timing depends on variety and conditions.");
      addRow("Timing margin", `${daysMargin} days`, daysMargin >= 0 ? "Days remaining before frost." : "Maturity is projected after frost.");

      byId("resultsCard").style.display = "block";
      byId("printBtn").style.display = "inline-block";
      setStatus("Results updated.");
    }

    function resetForm() {
      byId("firstFrost").value = "";
      byId("protection").value = "0";
      byId("buffer").value = "10";
      byId("crop").selectedIndex = 0;
      byId("resultsBody").innerHTML = "";
      byId("resultsCard").style.display = "none";
      byId("printBtn").style.display = "none";

      setError("");
      setStatus("");

      const outLastSow = byId("outLastSow");
      if (outLastSow) outLastSow.textContent = "—";
      const outEffectiveFrost = byId("outEffectiveFrost");
      if (outEffectiveFrost) outEffectiveFrost.textContent = "—";
      const outEffectiveNote = byId("outEffectiveNote");
      if (outEffectiveNote) outEffectiveNote.textContent = "";

      const t = byId("confidenceText");
      if (t) t.textContent = "";
      const h = byId("confidenceHelp");
      if (h) h.textContent = "";
    }

    function printResults() {
      window.print();
    }

    initCropSelect();
    byId("calcBtn").addEventListener("click", calculate);
    byId("resetBtn").addEventListener("click", resetForm);
    byId("printBtn").addEventListener("click", printResults);
  </script>
</body>
</html>
