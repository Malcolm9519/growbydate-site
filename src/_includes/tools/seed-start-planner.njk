
<section class="section">
  <div id="seed-start-planner" class="toolRoot"></div>
</section>


<!-- Structured Data: Tool -->
<script type="application/json" id="siteCropsJson">{{ crops | dump | safe }}</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Seed Starting Planner",
  "applicationCategory": "WebApplication",
  "operatingSystem": "Any",
  "isAccessibleForFree": true,
  "url": "https://growbydate.com/tools/seed-start-planner/",
  "publisher": { "@type": "Organization", "name": "GrowByDate" },
  "description": "A simple seed starting planner that calculates indoor start, hardening off, and outdoor planting windows from your average last frost date‚Äîdesigned for short growing seasons."
}
</script>

<!-- Structured Data: FAQ (keep in sync with the FAQ section below) -->
<style>
  .grid { display: grid; gap: 14px; }

  .row { display: grid; gap: 10px; grid-template-columns: 1fr; }

  /* Prevent grid children from overflowing their column (fixes date input ‚Äúspill‚Äù) */
  .row > div { min-width: 0; }

  label { font-weight: 600; }

  input[type="date"], input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 12px;
    font: inherit;
    box-sizing: border-box;
  }

  /* Extra safety for the frost date field specifically */
  #lastFrost { min-width: 0; max-width: 100%; }

  .small { font-size: 14px; opacity: .85; }
  .card + .card { margin-top: 14px; }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #e5e5e5; text-align: left; vertical-align: top; }
  th { font-weight: 700; }

  .pill { display: inline-block; padding: 2px 8px; border: 1px solid #222; border-radius: 999px; font-size: 12px; opacity: .9; }

  .warn { border: 1px solid #e3c46b; border-radius: 12px; padding: 10px 12px; background: #fff8e1; }
 .muted { color: rgba(0, 0, 0, 0.75); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border: 1px solid #111;
    border-radius: 12px;
    background: transparent;
    cursor: pointer;
    font: inherit;
    line-height: 1.2;
    white-space: nowrap;
    box-sizing: border-box;
  }
  .btn:hover { opacity: .85; }

  .btnRow { display:flex; align-items:end; gap:10px; flex-wrap: wrap; }

  /* If your primary action uses .button / .button.primary, normalize it to match .btn */
  .btnRow .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 12px;
    font: inherit;
    line-height: 1.2;
    white-space: nowrap;
    box-sizing: border-box;
  }

  .content { max-width: 760px; }

  .faq details { border: 1px solid #e8e8e8; border-radius: 12px; padding: 10px 12px; background: #fff; }
  .faq details + details { margin-top: 10px; }
  .faq summary { cursor: pointer; font-weight: 650; }

  .breadcrumbs { font-size: 14px; opacity: .85; margin-bottom: 10px; }
  .breadcrumbs a { text-decoration: none; }

  .linkRow { display:flex; gap:10px; flex-wrap: wrap; }
  .linkRow a { text-decoration: none; border-bottom: 1px solid currentColor; }

  .noteIcon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  line-height: 1;
}

#resultsBody svg {
  display: inline-block;
  vertical-align: middle;
  opacity: .85;
}

#resultsBody td.muted {
  opacity: 1;
  color: rgba(0, 0, 0, 0.75);
}

.noteIcon svg {
  display: inline-block;
  vertical-align: middle;
  opacity: .85;
}

/* Keep planner text ‚Äúmuted‚Äù without fading emoji/icons */
#resultsCard .muted,
#resultsCard .small {
  opacity: 1;
}

#resultsCard .muted {
  color: rgba(0, 0, 0, 0.75);
}


/* Print: only print the results card */
@media print {
  /* Hide everything by default */
  body * { visibility: hidden !important; }

  /* Show results */
  #resultsCard, #resultsCard * { visibility: visible !important; }

  /* Position results at top-left for printing */
  #resultsCard {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    display: block !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* Hide interactive controls inside results */
  #resultsActions { display: none !important; }
}


  /* Crop checklist */
.cropList {
  border: 1px solid var(--border, #ddd);
  border-radius: 10px;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px 10px;     /* row gap, column gap */
  max-height: none;  /* remove internal scroll */
  overflow: visible;
}
  .cropPickRow { margin: 0; }
  .cropPickLabel:hover { background: rgba(0,0,0,0.04); }
  .cropPickLabel input { flex: 0 0 auto; }
.cropPickName {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.cropPickLabel {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 999px;
  cursor: pointer;
  user-select: none;
  border: 1px solid rgba(0,0,0,0.10);
  background: rgba(0,0,0,0.02);
}

/* Remove the full-width stacking */
.cropPickLabel { width: auto; }

  /* Multi-crop clarity in results */
  .cropHeaderRow td { padding: 10px 12px; background: rgba(0,0,0,0.04); border-top: 1px solid rgba(0,0,0,0.08); }
  .cropHeaderRow:first-child td { border-top: 0; }
  .cropHeaderIcon { margin-right: 8px; }
  .cropHeaderLink { font-weight: 700; text-decoration: none; }
  .cropHeaderLink:hover { text-decoration: underline; }
  .cropSeparatorRow td { padding: 0; height: 10px; background: transparent; }

  /* Date range readability */
  .dateRange {
    display: inline-flex;
    align-items: baseline;
    gap: .35rem;
    font-variant-numeric: tabular-nums;
    letter-spacing: .2px;
    white-space: nowrap;
    background: rgba(0,0,0,0.035);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 10px;
    padding: 2px 8px;
  }
  .dateRange .date { font-weight: 400; }
  .dateRange .rangeSep { opacity: .65; }

</style>

<p class="lede">
  Enter your average last frost date ‚Äî or look it up with a ZIP or postal code ‚Äî and choose a crop. You‚Äôll get a clear window for starting seeds indoors, hardening off, and planting outside ‚Äî built for shorter growing seasons where timing matters.
</p>

<section class="card" aria-label="Seed starting planner inputs">
  <div class="stack">
    
    <div class="stack" style="margin-bottom:10px;">
      <h3 class="h4" style="margin:0 0 6px 0;">Start Here</h3>
      <label for="frost-lookup-input">Find my frost date (ZIP / postal code)</label>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
        <input type="text" id="frost-lookup-input" placeholder="ZIP or Postal Code" autocomplete="postal-code">
        <button id="lookup-btn" type="button">Find</button>
      </div>
      <div id="lookup-result" style="margin-top:10px;"></div>
    </div>
<div>
      <label for="lastFrost">Average last frost date</label>
      <input id="lastFrost" type="date" aria-describedby="lastFrostHelp" />
    </div>

    <div>
            <div style="margin-top:10px;">
      <label for="cropList">Crops</label>
      <div class="small" id="cropHelp">Select one or more crops.</div>
      <div id="cropList" class="cropList" aria-describedby="cropHelp"></div>
    </div>

    <div>
            <div style="margin-top:10px;">
      <label for="protection">Season protection</label>
      <div class="small" id="protectionHelp">This shifts outdoor planting windows slightly earlier (it does not change freeze damage at 32¬∞F / 0¬∞C).</div>
      <select id="protection" aria-describedby="protectionHelp">
        <option value="0">None (open garden)</option>
        <option value="7">Some protection (row cover / cloche) ‚Äî ~1 week earlier</option>
        <option value="14">More protection (cold frame / tunnel) ‚Äî ~2 weeks earlier</option>
        <option value="21">A lot of protection (heated / heavy cover) ‚Äî ~3 weeks earlier</option>
      </select>
    </div>

    <div class="btnRow">
      <button class="button primary" id="calcBtn" type="button">Calculate</button>
      <button class="btn" id="resetBtn" type="button">Reset</button>
</div>
  </div>
</section>

<section class="card" id="resultsCard" style="display:none;">
  <h2>Results</h2>
  <div class="small">
    <span class="pill">Planning tip</span>
    These are ranges. Spring weather can shift timing by a week or more ‚Äî if you‚Äôre unsure, use the later end of each window.
  </div>
  <table>
<tbody id="resultsBody"></tbody>
  </table>

  <div class="btnRow" id="resultsActions" style="margin-top:12px;">
    <button class="btn" id="copyBtn" type="button" style="display:none;">Copy plan</button>
    <button class="btn" id="printBtn" type="button" style="display:none;">Print</button>
    <button class="btn" id="csvBtn" type="button" style="display:none;">Download CSV</button>
    <button class="btn" id="txtBtn" type="button" style="display:none;">Download text</button>
  </div>

</section>
<section class="warn" id="warnBox" style="display:none;"></section>
<section class="card">
  <h2>How This Planner Works</h2>

  <p class="muted" style="margin-top:0;">
    This tool turns frost-based planning into clear date ranges.
    It uses your <a href="/guides/how-to-find-your-last-frost-date/">average last frost date</a>
    as the anchor and applies crop-specific timing to generate three windows:
    start indoors, harden off, and move outdoors.
  </p>

  <p class="small muted">
    For a deeper explanation of how these dates are calculated, see
    <a href="/guides/when-to-start-seeds-indoors/">When to Start Seeds Indoors</a>.
  </p>

  <div class="row" style="margin-top:10px;">
    <div class="muted">
      <div class="pill">1</div>
      <p style="margin:6px 0 0;"><strong>Enter your last frost date</strong></p>
      <p class="small" style="margin:6px 0 0;">
        Use your ‚Äúaverage‚Äù date for planning. If unsure, choose the midpoint of the range you find.
      </p>
    </div>

    <div class="muted">
      <div class="pill">2</div>
      <p style="margin:6px 0 0;"><strong>Choose a crop</strong></p>
      <p class="small" style="margin:6px 0 0;">
        The planner loads typical timing windows for that crop.
      </p>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="muted">
      <div class="pill">3</div>
      <p style="margin:6px 0 0;"><strong>Click Calculate</strong></p>
      <p class="small" style="margin:6px 0 0;">
        Start with the <strong>middle</strong> of each range unless you have a reason to adjust.
      </p>
    </div>

    <div class="muted">
      <div class="pill">4</div>
      <p style="margin:6px 0 0;"><strong>Adjust based on conditions</strong></p>
      <p class="small" style="margin:6px 0 0;">
        Earlier = protection or warm microclimate.  
        Later = slow spring, cold soil, wind, or shade.
      </p>
    </div>
  </div>

  <p class="small muted" style="margin-top:10px;">
    Frost dates guide planning ‚Äî but steady nighttime temperatures are your final signal.
  </p>

  <p class="muted" style="margin-top:0;">
    <strong>Before planting, review the <a href="/guides/seed-starting-supplies-checklist/">seed starting checklist</a> to avoid preventable mistakes.</strong>
  </p>
</section>

<section class="card">
  <h2>Why Last Frost Is the Anchor</h2>

  <p>
    The average last frost date is not a guarantee ‚Äî it is a planning reference.
    It represents the historical point when freeze risk drops low enough to begin scheduling warm-season crops.
  </p>

  <p>
    From that one date, you can:
  </p>

  <ul>
    <li>Count backward for indoor seed starting</li>
    <li>Count forward for outdoor transplant timing</li>
    <li>Build a hardening off window between them</li>
  </ul>

  <p>
    This frost-based framework works across northern U.S. climates and comparable Canadian regions because it adapts to your local freeze pattern instead of relying on a generic calendar.
  </p>
</section>

<script>
  // ---- Data model ----
  // indoorStartWeeks: [startEarlierWeeks, startLaterWeeks] relative to last frost (before last frost)
  // transplantWeeks:  [earlierWeeks, laterWeeks] relative to last frost (after subtracting protection offset)
  // directSowWeeks:   [earlierWeeks, laterWeeks] relative to last frost (can be negative = before frost date)
  let CROPS = [];

  // ---- Helpers ----
  const byId = (id) => document.getElementById(id);

  // Exportable plan rows (built during calculate)
  let PLAN_ROWS = [];
  let CURRENT_CROP = "";

  function stripHtml(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = html || "";
    return (tmp.textContent || "").replace(/\s+/g, " ").trim();
  }


  // Site crop metadata (slug, etc.) from Eleventy data. Used for linking.
  const SITE_CROPS = (() => {
    try {
      const el = document.getElementById("siteCropsJson");
      if (!el) return [];
      return JSON.parse(el.textContent || "[]");
    } catch (e) {
      return [];
    }
  })();

  const SITE_CROPS_BY_ID = Object.create(null);
  for (const c of SITE_CROPS) {
    if (c && c.id) SITE_CROPS_BY_ID[c.id] = c;
  }

  // CROPS used by this tool: pull from site data and include only crops that relate to this tool.
  CROPS = (SITE_CROPS || []).filter(c =>
    c && c.id &&
    Array.isArray(c.relatedTools) &&
    c.relatedTools.includes("seed-start-planner")
  );

  // Tool crop IDs don't always match site crop IDs (e.g., tomato ‚Üí tomatoes).
  const CROP_ID_ALIASES = {
    tomato: "tomatoes",
    pepper: "peppers",
  };

function cropIcon(id) {
  const icons = {
    tomato: "üçÖ",
    tomatoes: "üçÖ",
    pepper: "ü´ë",
    peppers: "ü´ë",
    cucumber: "ü•í",
    cucumbers: "ü•í",
    zucchini: "ü•í",      // no zucchini emoji; cucumber is closest
    bean: "ü´ò",
    beans: "ü´ò",
    lettuce: "ü•¨",
    spinach: "üçÉ",       // no spinach emoji; leafy greens works
    kale: "ü•¨",
    broccoli: "ü•¶",
    cabbage: "ü•¨",

    carrot: "ü•ï",
    carrots: "ü•ï",
    beet: "üü£",
    beets: "üü£",
    radish: "üî¥",
    radishes: "üî¥",
    onion: "üßÖ",
    onions: "üßÖ",
    pea: "üü¢",
    peas: "üü¢",
    garlic: "üßÑ",
    "swiss-chard": "ü•¨",
    cauliflower: "ü•¶",
    "winter-squash": "üéÉ"
  };

  return icons[id] || "üå±";
}


  function cropUrl(cropId) {
    const normalizedId = CROP_ID_ALIASES[cropId] || cropId;
    const meta = SITE_CROPS_BY_ID[normalizedId];
    const slug = meta && meta.slug ? meta.slug : normalizedId;
    return `/crops/${slug}/`;
  }

  function toDate(inputValue) {
    if (!inputValue) return null;
    const [y, m, d] = inputValue.split("-").map(Number);
    return new Date(y, m - 1, d, 12, 0, 0, 0); // local noon to reduce DST weirdness
  }

  function fmt(date) {
    return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  }

  

  function startIndoorsNote(crop) {
    const noteParts = [];

    if (crop.indoorStartWeeks && Array.isArray(crop.indoorStartWeeks)) {
      const [earlier, later] = crop.indoorStartWeeks;
      const leadWeeks = Math.max(0, Math.round((earlier + later) / 2));

      if (leadWeeks >= 9) noteParts.push("Long lead-time crop: starting on schedule helps avoid a late harvest.");
      else if (leadWeeks <= 4) noteParts.push("Short lead-time crop: don‚Äôt start too early or seedlings outgrow their space.");

      if (crop.seasonType === "warm") {
        noteParts.push("Warm-season seedlings stay stocky with strong light and warm nights indoors.");
      } else if (crop.seasonType === "cool") {
        noteParts.push("Cool-season seedlings tolerate cooler indoor temps; avoid overheating under lights.");
      }
    }

    if (crop.notes) noteParts.push(crop.notes);
    return noteParts.join(" ").trim();
  }

  function noIndoorStartNote(crop) {
    const noteParts = [];
    if (crop.directSowWeeks) noteParts.push("Usually direct sown.");
    else if (crop.transplantWeeks) noteParts.push("Usually transplanted as a purchased start or from trays.");
    if (crop.seasonType === "warm") noteParts.push("Warm-season crops still need warm soil/nights outside.");
    if (crop.notes) noteParts.push(crop.notes);
    return noteParts.join(" ").trim();
  }

  function fmtRange(start, end) {
    return `<span class="dateRange"><span class="date">${fmt(start)}</span><span class="rangeSep">‚Üí</span><span class="date">${fmt(end)}</span></span>`;
  }

  function frostToleranceNote(ft) {
    const s = String(ft || "").toLowerCase();
    if (!s) return "";
    if (s.includes("none") || s.includes("protect")) return "Tender crop ‚Äî protect from any frost.";
    if (s.includes("semi") || s.includes("half")) return "Handles light frost; protect if temperatures dip further.";
    if (s.includes("hardy")) return "Tolerates light frosts; hard freezes can still damage.";
    return "Use row cover if frost is in the forecast.";
  }
function addDays(date, days) {
    const out = new Date(date);
    out.setDate(out.getDate() + days);
    return out;
  }

  function weeksToDays(weeks) { return Math.round(weeks * 7); }

  function windowFromWeeks(anchorDate, earlierWeeks, laterWeeks, protectionDays) {
    const start = addDays(anchorDate, -weeksToDays(earlierWeeks));
    const end   = addDays(anchorDate, -weeksToDays(laterWeeks));
    return [start, end].map(d => addDays(d, -protectionDays));
  }

  function windowFromWeeksRelative(anchorDate, earlierWeeks, laterWeeks, protectionDays) {
    const start = addDays(anchorDate, weeksToDays(earlierWeeks));
    const end   = addDays(anchorDate, weeksToDays(laterWeeks));
    return [start, end].map(d => addDays(d, -protectionDays));
  }

  function addRow(task, windowText, notes) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${task}</strong></td>
      <td>${windowText}</td>
      <td class="muted">${notes || ""}</td>
    `;
    byId("resultsBody").appendChild(tr);

    // Build export rows (skip the decorative Crop header row; crop is already a column)
    if (task !== "Crop") {
      PLAN_ROWS.push({
        crop: CURRENT_CROP,
        task: stripHtml(task),
        window: stripHtml(windowText),
        notes: stripHtml(notes || "")
      });
    }
  }

  function addCropHeader(crop) {
    const tr = document.createElement("tr");
    tr.className = "cropHeaderRow";
    tr.innerHTML = `
      <td colspan="3">
        <span class="cropHeaderIcon" aria-hidden="true">${cropIcon(crop.id)}</span>
        <a class="cropHeaderLink" href="${cropUrl(crop.id)}">${crop.name}</a>
      </td>
    `;
    byId("resultsBody").appendChild(tr);
  }

  function addSeparator() {
    const tr = document.createElement("tr");
    tr.className = "cropSeparatorRow";
    tr.innerHTML = `<td colspan="3"></td>`;
    byId("resultsBody").appendChild(tr);
  }

  // ---- Init UI ----
function initCropSelect() {
  const list = byId("cropList");
  list.innerHTML = "";

  // Sort crops alphabetically by name (without mutating original array)
  const sortedCrops = [...CROPS].sort((a, b) =>
    a.name.localeCompare(b.name, undefined, { sensitivity: "base" })
  );

  for (const c of sortedCrops) {
    const id = `crop_${c.id}`;
    const row = document.createElement("div");
    row.className = "cropPickRow";

    row.innerHTML = `
      <label class="cropPickLabel" for="${id}">
        <input type="checkbox" id="${id}" name="cropPick" value="${c.id}" />
        <span class="cropPickName"><span class="cropPickIcon" aria-hidden="true">${cropIcon(c.id)}</span>${c.name}</span>
      </label>
    `;
    list.appendChild(row);
  }
  // Default: no crop selected (user chooses)
}

initCropSelect();

  // ---- Main calculate ----
  function calculate() {
    byId("warnBox").style.display = "none";
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    PLAN_ROWS = [];
    byId("printBtn").style.display = "none";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";

    const frost = toDate(byId("lastFrost").value);
    const protectionDays = parseInt(byId("protection").value, 10) || 0;
    const selectedCropIds = Array.from(document.querySelectorAll('input[name="cropPick"]:checked')).map(el => el.value);
    if (!selectedCropIds.length) {
      byId("warnBox").style.display = "block";
      byId("warnBox").innerHTML = "Please select at least one crop.";
      return;
    }
    const selectedCrops = selectedCropIds.map(id => CROPS.find(c => c.id === id)).filter(Boolean);

    if (!frost) {
      byId("warnBox").style.display = "block";
      byId("warnBox").innerHTML = "Please enter an average <strong>last frost date</strong> to calculate your windows.";
      return;
    }

    // One plan can include multiple crops
    for (let i = 0; i < selectedCrops.length; i++) {
      const crop = selectedCrops[i];
      CURRENT_CROP = crop.name || crop.id;      // Crop header
      addCropHeader(crop);

// Indoor start window (not shifted by protection)
      if (crop.indoorStartWeeks) {
        const [earlier, later] = crop.indoorStartWeeks;
        const [start, end] = windowFromWeeks(frost, earlier, later, 0);
        addRow("Start seeds indoors", `${fmtRange(start, end)}`, startIndoorsNote(crop));
      } else {
        addRow("Start seeds indoors", "Not typically recommended", noIndoorStartNote(crop));
      }

      // Track the first outdoor step for harvest estimates
      let firstOutdoorDate = null;
      let firstOutdoorLabel = null;

      // Transplant window (shifted earlier by protection)
      if (crop.transplantWeeks) {
        const [earlier, later] = crop.transplantWeeks;
        const [start, end] = windowFromWeeksRelative(frost, earlier, later, protectionDays);
        const hardenStart = addDays(start, -10);
        const hardenEnd = addDays(start, -7);
        addRow("Begin hardening off", `${fmtRange(hardenStart, hardenEnd)}`, "Start gradual outdoor exposure ~7‚Äì10 days before transplanting.");
        addRow("Transplant outdoors", `${fmtRange(start, end)}`, protectionDays ? "Shifted earlier due to season protection." : "Open-garden timing.");

        firstOutdoorDate = start;
        firstOutdoorLabel = "transplanting";
      } else {
        addRow("Transplant outdoors", "Not applicable", "");
      }

      // Direct sow window (shifted earlier by protection)
      if (crop.directSowWeeks) {
        const [earlier, later] = crop.directSowWeeks;
        const [start, end] = windowFromWeeksRelative(frost, earlier, later, protectionDays);
        addRow("Direct sow outdoors", `${fmtRange(start, end)}`, protectionDays ? "Shifted earlier due to season protection." : "");

        // Use direct sow as the anchor if we didn't already anchor on transplant
        if (!firstOutdoorDate) {
          firstOutdoorDate = start;
          firstOutdoorLabel = "direct sowing";
        }
      } else {
        addRow("Direct sow outdoors", "Not typical for this crop", "");
      }

      // Estimated first harvest window (from first outdoor step)
      if (firstOutdoorDate && Array.isArray(crop.daysToMaturity) && crop.daysToMaturity.length === 2) {
        const [minDays, maxDays] = crop.daysToMaturity;
        if (Number.isFinite(minDays) && Number.isFinite(maxDays)) {
          const estMin = addDays(firstOutdoorDate, minDays);
          const estMax = addDays(firstOutdoorDate, maxDays);
          addRow(
            "Estimated first harvest",
            `${fmtRange(estMin, estMax)}`,
            `Based on ${minDays}‚Äì${maxDays} days to maturity from ${firstOutdoorLabel}.`
          );
        }
      }

      // Frost tolerance (placed near bottom so action steps stay at the top)
      if (crop.frostTolerance) {
        addRow("Frost tolerance", crop.frostTolerance, frostToleranceNote(crop.frostTolerance));
      }

      if (i < selectedCrops.length - 1) addSeparator();
    }
// Confidence note
    byId("resultsCard").style.display = "block";
    // Scroll to results after rendering
setTimeout(() => {
  const results = byId("resultsCard");
  if (results) {
    results.scrollIntoView({
      behavior: "smooth",
      block: "start"
    });
  }
}, 50);
    byId("printBtn").style.display = "inline-block";
    byId("copyBtn").style.display = "inline-block";
    byId("csvBtn").style.display = "inline-block";
    byId("txtBtn").style.display = "inline-block";
  }

  function resetForm() {
    byId("lastFrost").value = "";
    byId("protection").value = "0";
    for (const opt of byId("crop").options) opt.selected = false;
    // Select the first option for a sensible default
    if (byId("crop").options.length) byId("crop").options[0].selected = true;
    byId("warnBox").style.display = "none";
    byId("resultsCard").style.display = "none";
    byId("resultsBody").innerHTML = "";
    byId("printBtn").style.display = "none";
    byId("copyBtn").style.display = "none";
    byId("csvBtn").style.display = "none";
    byId("txtBtn").style.display = "none";
  }


  // ---- Export helpers ----
  function planToCSV(rows) {
    const esc = (v) => {
      const s = String(v ?? "");
      // Escape quotes and wrap fields that contain commas/newlines/quotes
      const needs = /[",\n\r]/.test(s);
      const out = s.replace(/"/g, '""');
      return needs ? `"${out}"` : out;
    };
    const header = ["Crop", "Task", "Window", "Notes"];
    const lines = [header.map(esc).join(",")];
    for (const r of rows) {
      lines.push([r.crop, r.task, r.window, r.notes].map(esc).join(","));
    }
    return lines.join("\n");
  }

  function planToText(rows) {
    // Group by crop, keep original order
    const groups = new Map();
    for (const r of rows) {
      if (!groups.has(r.crop)) groups.set(r.crop, []);
      groups.get(r.crop).push(r);
    }

    const out = [];
    out.push("GrowByDate.com ‚Äî Seed Starting Plan");
    const frostVal = byId("lastFrost").value ? fmt(toDate(byId("lastFrost").value)) : "";
    const prot = parseInt(byId("protection").value, 10) || 0;
    if (frostVal) out.push(`Last frost (average): ${frostVal}`);
    out.push(`Season extension (days): ${prot}`);
    out.push("");
    out.push("Freeze damage can begin at 32¬∞F / 0¬∞C.");
    out.push("");

    for (const [crop, items] of groups.entries()) {
      out.push(crop);
      out.push("-".repeat(Math.min(60, crop.length)));
      for (const r of items) {
        out.push(`‚Ä¢ ${r.task}: ${r.window}${r.notes ? " ‚Äî " + r.notes : ""}`);
      }
      out.push("");
    }
    return out.join("\n");
  }

  function downloadFile(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyPlan() {
    const txt = planToText(PLAN_ROWS);
    try {
      await navigator.clipboard.writeText(txt);
      byId("copyBtn").textContent = "Copied!";
      setTimeout(() => (byId("copyBtn").textContent = "Copy plan"), 1200);
    } catch (e) {
      // Fallback: prompt (still lightweight)
      window.prompt("Copy your plan:", txt);
    }
  }

  function downloadCSV() {
    const csv = planToCSV(PLAN_ROWS);
    const stamp = byId("lastFrost").value || "plan";
    downloadFile(`seed-start-plan-${stamp}.csv`, csv, "text/csv;charset=utf-8");
  }

  function downloadText() {
    const txt = planToText(PLAN_ROWS);
    const stamp = byId("lastFrost").value || "plan";
    downloadFile(`seed-start-plan-${stamp}.txt`, txt, "text/plain;charset=utf-8");
  }


  function printResults() {
    window.print();
  }

  byId("calcBtn").addEventListener("click", calculate);
  byId("resetBtn").addEventListener("click", resetForm);
  byId("printBtn").addEventListener("click", printResults);
  byId("copyBtn").addEventListener("click", copyPlan);
  byId("csvBtn").addEventListener("click", downloadCSV);
  byId("txtBtn").addEventListener("click", downloadText);
</script>

<script type="module">
  import {
    lookupFrost,
    populateDateInput,
    renderResultCard,
    buildPlannerLink,
    applyQueryPrefill
  } from "/assets/js/frost-lookup.js";

  const lastFrostInput = document.getElementById("lastFrost");
  const input = document.getElementById("frost-lookup-input");
  const btn = document.getElementById("lookup-btn");
  const out = document.getElementById("lookup-result");

  function anyCropSelected() {
    return Array.from(document.querySelectorAll('#cropList input[type="checkbox"]'))
      .some((el) => el.checked);
  }

  function runPlannerIfReady() {
    // Only run if user has selected a crop (prevents auto-running with an unintended default).
    if (!anyCropSelected()) return;
    const calcBtn = document.getElementById("calcBtn");
    if (calcBtn) calcBtn.click();
  }

  async function doLookup() {
    if (!input || !out) return;
    const frost = await lookupFrost(input.value);

    renderResultCard(out, frost);


    if (frost && lastFrostInput) {
      populateDateInput(lastFrostInput, frost.lastFrost);
      // Keep the top reference clean: bring the Average last frost date field to the top of the viewport.
      const lastFrostLabel = document.querySelector('label[for="lastFrost"]') || lastFrostInput;

      // Use an explicit offset so the field becomes the clean top reference (accounts for sticky headers).
      if (lastFrostLabel) {
        const y = lastFrostLabel.getBoundingClientRect().top + window.scrollY - 80;
        window.scrollTo({ top: y, behavior: "smooth" });
      }

      // Focus crop selection without triggering an extra scroll jump.
      const firstCrop = document.querySelector('#cropList input[type="checkbox"]');
      try {
        firstCrop?.focus({ preventScroll: true });
      } catch {
        // Older browsers: focus may scroll; acceptable fallback.
        firstCrop?.focus();
      }
    }
  }

  if (btn) btn.addEventListener("click", doLookup);
  if (input) input.addEventListener("keydown", (e) => { if (e.key === "Enter") doLookup(); });

  // Query param prefill: ?lastFrost=MM-DD
  applyQueryPrefill("lastFrost", lastFrostInput, () => runPlannerIfReady());
</script>
